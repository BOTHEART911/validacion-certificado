<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Validación de Certificado</title>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <style>
    :root{
      --primary:#06402B;
      --primary-2:#04281C;
      --ok:#16a34a;
      --error:#dc2626;
      --card:rgba(255,255,255,.85);
      --border:#ddd;
      --muted:#6b7280;
    }
    html,body{
      margin:0;
      padding:0;
      height:100%;
      width:100%;
      overflow-x:hidden;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:#111;
      background: url('https://res.cloudinary.com/dqqeavica/image/upload/v1746905869/fondo_rosa_n775m4.png') center/cover fixed no-repeat;
    }
    .container{ max-width: 980px; margin: 0 auto; padding: 16px; box-sizing:border-box; }
    .card{
      background: var(--card);
      backdrop-filter: blur(3px);
      border: 2px solid var(--border);
      border-radius: 16px;
      box-shadow: 0 8px 20px rgba(0,0,0,.18);
      max-width: 860px;
      margin: 16px auto;
      padding: 20px 20px 16px;
      box-sizing:border-box;
    }
    h1{ margin: 8px 0 12px; text-align:center; color: var(--primary); letter-spacing:.2px; }
    p.helper{ color:#444; font-size:.95rem; text-align:center; margin: 8px 0 16px; font-weight:600; }
    .center{ text-align:center; }
    .pill{
      display:inline-flex; align-items:center; justify-content:center;
      padding: 10px 14px; border-radius: 999px; font-weight: 900;
      border: 2px solid var(--primary); background:#fff; gap:8px;
    }
    .pill.ok{ border-color: var(--ok); color: var(--ok); }
    .pill.bad{ border-color: var(--error); color: var(--error); }
    .grid{ display:grid; grid-template-columns:1fr; gap:10px; margin-top:14px; }
    .row{ background:#fff; border:1.5px solid #e5e7eb; border-radius:12px; padding:10px 12px; }
    .k{ font-weight:900; color:var(--primary); font-size:.82rem; margin:0 0 2px; }
    .v{ margin:0; font-weight:700; color:#111; word-break:break-word; }
    .btn{
      width:100%; padding:12px; border-radius:10px; border:2px solid var(--primary);
      background:var(--primary); color:#fff; font-weight:900; cursor:pointer;
      transition:transform .08s ease, background .2s ease, border-color .2s ease;
    }
    .btn:hover{ background:var(--primary-2); border-color:var(--primary-2); }
    .btn:active{ transform:scale(.99); }
    .btn-secondary{
      background:#fff; color:#000; border-color:var(--primary); margin-top:10px;
    }
    .btn-secondary:hover{ background:var(--primary-2); color:#fff; border-color:var(--primary-2); }
    .footer{ margin-top:16px; text-align:center; color:var(--muted); font-size:.85rem; }
    .tiny{ font-size:.8rem; color:#374151; margin-top:10px; text-align:center; }
    .muted{ color:var(--muted); font-weight:600; }
  </style>
</head>
<body>
  <main class="container">
    <section class="card">
      <h1>VALIDACIÓN DE CERTIFICADO</h1>

      <div class="center" style="margin-bottom:10px;">
        <span id="badge" class="pill">CARGANDO…</span>
        <p id="subtitle" class="helper"></p>
      </div>

      <div id="grid" class="grid"></div>

      <div style="margin-top:14px;">
        <button id="btnCopiar" class="btn">COPIAR DATOS</button>
        <button id="btnAbrirWebApp" class="btn btn-secondary">ABRIR VALIDACIÓN EN WEBAPP</button>
        <p class="tiny muted" id="corsHint" style="display:none;">
          Si el navegador bloquea la consulta, usa “ABRIR VALIDACIÓN EN WEBAPP”.
        </p>
      </div>

      <div class="footer">Copyright © <b>GOBIERNO DIGITAL</b></div>
    </section>
  </main>

  <script>
    const WEBAPP_BASE = 'https://script.google.com/macros/s/AKfycbx5nz42xZ53WEM55Kmt_i9ngh9bn_qZjjHo3_Ub_nSz3MO0B8YDbapwk7s0LQhhnG0X/exec';

    const SOUNDS = {
      info: 'https://res.cloudinary.com/dqqeavica/video/upload/v1759011578/Default_notification_pkp4wr.mp3',
      success: 'https://res.cloudinary.com/dqqeavica/video/upload/v1759011577/Pay_success_t5aawh.mp3',
      error: 'https://res.cloudinary.com/dqqeavica/video/upload/v1759011578/Low_battery_d5qua1.mp3'
    };

    let DOC_DATA = null;

    function playSoundOnce(url){
      try{
        const a = new Audio(url);
        a.preload = 'auto';
        a.play().catch(()=>{});
      }catch(e){}
    }

    function getParam(name){
      return new URLSearchParams(location.search).get(name) || '';
    }

    function setBadge(ok){
      const badge = document.getElementById('badge');
      const subtitle = document.getElementById('subtitle');

      if(ok){
        badge.textContent = 'DOCUMENTO VÁLIDO';
        badge.className = 'pill ok';
        subtitle.textContent = 'Este certificado fue generado por el sistema.';
        return;
      }

      badge.textContent = 'NO VÁLIDO';
      badge.className = 'pill bad';
      subtitle.textContent = 'No se encontró el ID en la base de datos.';
    }

    function clearGrid(){
      document.getElementById('grid').innerHTML = '';
    }

    function addRow(k,v, opts){
  const g = document.getElementById('grid');
  const row = document.createElement('div');
  row.className = 'row';

  const pk = document.createElement('p');
  pk.className = 'k';
  pk.textContent = k;

  const pv = document.createElement('p');
  pv.className = 'v';
  pv.textContent = v || '';

  if(opts && opts.justify){
    pv.style.textAlign = 'justify';
    pv.style.textJustify = 'inter-word';
  }

  row.appendChild(pk);
  row.appendChild(pv);
  g.appendChild(row);
}

    function showCorsHintIfNeeded(){
      const hint = document.getElementById('corsHint');
      try{
        const here = location.origin;
        const webAppOrigin = new URL(WEBAPP_BASE).origin;
        if(here !== webAppOrigin){
          hint.style.display = '';
        }
      }catch(e){}
    }

    function buildWebAppVerifyUrl(idDoc){
      return WEBAPP_BASE + '?' + [
        'action=verificarCertificado',
        'idDoc=' + encodeURIComponent(idDoc)
      ].join('&');
    }

    async function fetchDocJson(idDoc){
      const url = new URL(WEBAPP_BASE);
      url.search = new URLSearchParams({
        action: 'getCertificadoById',
        idDoc: idDoc
      }).toString();

      const r = await fetch(url.toString(), { method:'GET' });
      const j = await r.json();
      if(!j || !j.ok) return null;
      return j.data || null;
    }

    async function load(){
      showCorsHintIfNeeded();

      const idDoc = String(getParam('idDoc') || '').trim();
      clearGrid();
      DOC_DATA = null;

      if(!idDoc){
        setBadge(false);
        addRow('ID CERTIFICADO','');
        return;
      }

      addRow('ID CERTIFICADO', idDoc);

      try{
        DOC_DATA = await fetchDocJson(idDoc);
      }catch(e){
        setBadge(false);
        addRow('ERROR', 'No se pudo consultar (posible CORS o red).');
        return;
      }

      if(!DOC_DATA || !DOC_DATA.valido){
        setBadge(false);
        return;
      }

      setBadge(true);
      addRow('CONTRATISTA', DOC_DATA.nombre);
      addRow('DOCUMENTO', DOC_DATA.documento);
      addRow('CONTRATO', DOC_DATA.contrato);
      addRow('FECHA CONTRATO', DOC_DATA.fechaContrato);
      addRow('OBJETO', DOC_DATA.objeto, { justify:true });
      addRow('VALOR INICIAL', DOC_DATA.valorI);
      addRow('MRA', DOC_DATA.mra);
      addRow('VALOR FINAL', DOC_DATA.valorF);
      addRow('FECHA DE INICIO', DOC_DATA.fechaInicio);
      addRow('FECHA DE TERMINACIÓN', DOC_DATA.fechaTermino);
      addRow('ESTADO DEL CONTRATO', DOC_DATA.estadoContrato);
    }

    document.getElementById('btnCopiar').addEventListener('click', async ()=>{
      function safe(v){ return (v === null || v === undefined) ? '' : String(v); }
      function line(k,v){ return k + ': ' + safe(v); }

      const idDoc = String(getParam('idDoc') || '').trim();

      const lines = [];
      if(DOC_DATA && DOC_DATA.valido){
        lines.push(line('ID CERTIFICADO', DOC_DATA.idDoc));
        lines.push(line('CONTRATISTA', DOC_DATA.nombre));
        lines.push(line('DOCUMENTO', DOC_DATA.documento));
        lines.push(line('CONTRATO', DOC_DATA.contrato));
        lines.push(line('FECHA CONTRATO', DOC_DATA.fechaContrato));
        lines.push(line('OBJETO', DOC_DATA.objeto));
        lines.push(line('VALOR INICIAL', DOC_DATA.valorI));
        lines.push(line('MRA', DOC_DATA.mra));
        lines.push(line('VALOR FINAL', DOC_DATA.valorF));
        lines.push(line('FECHA DE INICIO', DOC_DATA.fechaInicio));
        lines.push(line('FECHA DE TERMINACIÓN', DOC_DATA.fechaTermino));
        lines.push(line('ESTADO DEL CONTRATO', DOC_DATA.estadoContrato));
      }else{
        lines.push(line('ID CERTIFICADO', idDoc));
        lines.push(line('ESTADO', 'NO VÁLIDO'));
      }

      const text = lines.join('\n');
      if(!text.trim()){
        Swal.fire({icon:'info',title:'Sin datos para copiar'});
        playSoundOnce(SOUNDS.info);
        return;
      }

      try{
        if(navigator.clipboard && navigator.clipboard.writeText){
          await navigator.clipboard.writeText(text);
        }else{
          const ta = document.createElement('textarea');
          ta.value = text;
          ta.setAttribute('readonly','');
          ta.style.position = 'fixed';
          ta.style.left = '-9999px';
          document.body.appendChild(ta);
          ta.select();
          document.execCommand('copy');
          document.body.removeChild(ta);
        }
        Swal.fire({icon:'success',title:'Datos copiados',timer:1600,showConfirmButton:false});
        playSoundOnce(SOUNDS.success);
      }catch(e){
        Swal.fire({icon:'error',title:'No se pudo copiar'});
        playSoundOnce(SOUNDS.error);
      }
    });

    document.getElementById('btnAbrirWebApp').addEventListener('click', ()=>{
      const idDoc = String(getParam('idDoc') || '').trim();
      const url = buildWebAppVerifyUrl(idDoc);
      window.open(url, '_blank', 'noopener');
    });

    document.addEventListener('click', ()=>{
      const badge = document.getElementById('badge');
      const ok = badge.classList.contains('ok');
      playSoundOnce(ok ? SOUNDS.success : SOUNDS.error);
    }, { once:true });

    load();
  </script>
</body>
</html>
